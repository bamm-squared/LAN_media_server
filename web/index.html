<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Chunkflix (Web)</title>
<style>
  :root{
    --bg:#0f0f12; --fg:#f3f3f5; --muted:#a6a6b0; --accent:#6aa2ff;
    --card:#1a1a20; --card2:#22222a; --danger:#ff4d4d;
  }
  html,body{margin:0;height:100%;background:var(--bg);color:var(--fg);font:14px/1.4 -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,system-ui,Arial;}
  .app{display:flex; height:100vh; overflow:hidden;}
  .sidebar{width:140px; min-width:120px; background:var(--card); padding:16px; box-sizing:border-box; overflow:auto; border-right:1px solid #2a2a33;}
  .path{padding:12px; border-bottom:1px solid #2a2a33; font-weight:600; white-space:nowrap; overflow:auto;}
  .folders{list-style:none; padding:0; margin:12px 0 0 0;}
  .folders li{display:flex; overflow:hidden; padding:8px 10px; margin:4px 0; background:var(--card2); border-radius:8px; cursor:pointer; user-select:none;}
  .folders li:hover{outline:1px solid #333a; background:#252530;}
  .folders li.up{color:var(--muted);}
  .folders .lock{flex:0 0 auto; margin-left:8px; opacity:.7}
  .main{flex:1; padding:16px; overflow:auto;}
  .grid{display:grid; grid-template-columns:repeat(auto-fill, minmax(180px, 1fr)); gap:16px;}
  .card{background:var(--card); border-radius:12px; overflow:hidden; box-shadow:0 1px 0 #0008; display:flex; flex-direction:column;}
  .thumb{aspect-ratio:16/12; background:#0b0b0f; display:flex; align-items:center; justify-content:center;}
  .thumb img{width:100%; height:100%; object-fit:contain; background:#0b0b0f;}
  .label{padding:10px 10px 12px; color:var(--fg); min-height:2.8em; display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical; overflow:hidden;}
  .muted{color:var(--muted)}
  .row{display:flex; align-items:center; gap:6px;}
  .btn{padding:6px 10px; background:var(--accent); color:#111; border:none; border-radius:8px; cursor:pointer; font-weight:600;}
  .btn:disabled{opacity:.5; cursor:not-allowed}
  .danger{background:var(--danger); color:white}
  .topbar{display:flex; gap:8px; align-items:center; padding:0 16px 12px;}
  .status{margin-left:auto; color:var(--muted); font-size:12px}

  /* Modal */
  .modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.5);}
  .dialog{background:var(--card); padding:20px; border-radius:12px; width:min(90vw,400px)}
  .dialog h3{margin:0 0 10px}
  .dialog .field{display:flex; gap:8px; margin-top:10px}
  .dialog input{flex:1; background:#101017; color:var(--fg); border:1px solid #2a2a33; border-radius:8px; padding:10px}
  .dialog .actions{display:flex; justify-content:flex-end; gap:10px; margin-top:14px}

  /* Video overlay */
  .player{position:fixed; z-index:9999; inset:0; background:#000c; display:none; align-items:center; justify-content:center;}
  .player-inner{background:#000; width:min(90vw,1000px); aspect-ratio:16/9; position:relative; border-radius:8px; overflow:hidden;}
  .player video{width:100%; height:100%; z-index:1;}
  .player .close{position:absolute; right:10px; top:10px; z-index:2; pointer-events:auto; background:#000b; color:#fff; border:none; border-radius:8px; padding:6px 10px; cursor:p>

  .hidden{display:none!important}
</style>
</head>
<body>
<div class="path" id="breadcrumb">/</div>
<div class="app">
  <aside class="sidebar">
    <div class="row">
      <button class="btn" id="btnRoot">Root</button>
      <button class="btn" id="btnSettings">Server</button>
    </div>
    <ul class="folders" id="folders"></ul>
  </aside>
  <main class="main">
    <div class="topbar">
      <div class="row">
        <span class="muted" id="dirLabel">Loading...</span>
      </div>
      <span class="status" id="status"></span>
    </div>
    <div class="grid" id="grid"></div>
  </main>
</div>

<!-- PIN Modal -->
<div class="modal" id="pinModal">
  <div class="dialog">
    <h3>Restricted Folder</h3>
    <div>Enter parental PIN to unlock.</div>
    <div class="field"><input id="pinInput" type="password" inputmode="numeric" pattern="[0-9]*" maxlength="12" placeholder="PIN"/></div>
    <div class="actions">
      <button class="btn" id="pinCancel">Cancel</button>
      <button class="btn" id="pinOk">OK</button>
    </div>
    <div class="muted" id="pinError" style="margin-top:8px;color:#ff9f9f"></div>
  </div>
</div>

<!-- Settings Modal -->
<div class="modal" id="settingsModal">
  <div class="dialog">
    <h3>Server</h3>
    <div>Enter media server base URL (same Pi):</div>
    <div class="field"><input id="serverInput" placeholder="http://192.168.10.63:8000"/></div>
    <div class="actions">
      <button class="btn" id="settingsCancel">Cancel</button>
      <button class="btn" id="settingsOk">Save</button>
    </div>
  </div>
</div>

<!-- Player Overlay -->
<div class="player" id="player">
  <div class="player-inner">
    <button class="close" id="playerClose">✕ Close</button>
    <video id="video" controls playsinline></video>
  </div>
</div>

<script>
(() => {
  // --- Config & state ---
  const els = {
    folders: document.getElementById('folders'),
    grid: document.getElementById('grid'),
    dirLabel: document.getElementById('dirLabel'),
    status: document.getElementById('status'),
    breadcrumb: document.getElementById('breadcrumb'),
    btnRoot: document.getElementById('btnRoot'),
    btnSettings: document.getElementById('btnSettings'),
    // PIN
    pinModal: document.getElementById('pinModal'),
    pinInput: document.getElementById('pinInput'),
    pinOk: document.getElementById('pinOk'),
    pinCancel: document.getElementById('pinCancel'),
    pinError: document.getElementById('pinError'),
    // Settings
    settingsModal: document.getElementById('settingsModal'),
    serverInput: document.getElementById('serverInput'),
    settingsOk: document.getElementById('settingsOk'),
    settingsCancel: document.getElementById('settingsCancel'),
    // Player
    player: document.getElementById('player'),
    playerClose: document.getElementById('playerClose'),
    video: document.getElementById('video'),
  };

  // Use same-origin by default (since we host the page on the Pi).
  const storage = window.localStorage;
  let SERVER = storage.getItem('serverBase') || window.location.origin;
  let authToken = "";           // token for current restricted folder
  let pendingDir = null;        // dir we attempted that needs PIN
  const stack = [];             // breadcrumb [{id,name}]

  // --- Utilities ---
  const stripExt = (s) => s.replace(/\.[^.]+$/, '');
  const qs = (obj) => Object.entries(obj)
                     .filter(([,v]) => v != null && v !== '')
                     .map(([k,v]) => `${encodeURIComponent(k)}=${encodeURIComponent(v)}`).join('&');
  const setStatus = (t) => els.status.textContent = t || '';

  function normalizeBrowse(json) {
    if (!json) return null;
    if (json.dir) {
      const out = { dirId: json.dir.id, dirName: json.dir.name || json.dir.title || 'Untitled', folders: [], videos: [] };
      (json.subdirs||[]).forEach(d => out.folders.push({ id: d.id, name: d.name || d.title }));
      (json.media||[]).forEach(m => out.videos.push({ id: m.id, name: m.name || m.title || m.filename }));
      return out;
    }
    if (json.folder && json.items) {
      const out = { dirId: json.folder.id, dirName: json.folder.name || json.folder.title, folders: [], videos: [] };
      json.items.forEach(it => {
        const t = (it.type||'').toLowerCase();
        if (t === 'folder' || t === 'directory') out.folders.push({ id: it.id, name: it.name || it.title });
        else out.videos.push({ id: it.id, name: it.name || it.title });
      });
      return out;
    }
    return null;
  }

  // Fetch helper that attaches Authorization when we have a token
  async function api(path, opts={}) {
    const url = SERVER + path;
    const headers = Object.assign({'Accept':'application/json'}, opts.headers||{});
    if (authToken) headers['Authorization'] = 'Bearer ' + authToken;
    const resp = await fetch(url, Object.assign({}, opts, {headers}));
    // If this is a browse call and we got 401/403, synthesize authorized:false
    if (!resp.ok && (resp.status === 401 || resp.status === 403)) {
      return { ok:false, json:{ authorized:false } };
    }
    let json = null;
    try { json = await resp.json(); } catch(e) {}
    return { ok: resp.ok, json, status: resp.status };
  }

  // --- Rendering ---
  function renderPath() {
    const p = stack.map(s => s.name).join('/');
    els.breadcrumb.textContent = '/' + p;
  }

  function renderFolders(items) {
    els.folders.innerHTML = '';
    if (stack.length > 1) {
      const li = document.createElement('li');
      li.className = 'up';
      li.textContent = '.. (Up)';
      li.onclick = () => goUp();
      els.folders.appendChild(li);
    }
    items.forEach(f => {
      const li = document.createElement('li');
      li.textContent = f.name;
      // visual hint if likely restricted (server doesn't flag, so skip icon unless desired)
      const lock = document.createElement('span'); lock.className='lock'; lock.textContent='';
      li.appendChild(lock);
      li.onclick = () => browseInto(f.id, f.name);
      els.folders.appendChild(li);
    });
  }

  function renderFiles(videos) {
    els.grid.innerHTML = '';
    videos.forEach(v => {
      const card = document.createElement('div'); card.className = 'card';
      const th = document.createElement('div'); th.className = 'thumb';
      const img = document.createElement('img');
      const base = stripExt(v.name||'');
      const art = SERVER + '/api/art?' + qs({ name: base, token: authToken||'' });
      img.src = art;
      img.alt = base;
      th.appendChild(img);
      const lbl = document.createElement('div'); lbl.className = 'label'; lbl.textContent = base || v.name || 'Untitled';
      card.appendChild(th); card.appendChild(lbl);
      card.onclick = () => play(v.id, v.name);
      els.grid.appendChild(card);
    });
  }

  // --- Navigation ---
  async function browse(dirId=null) {
    setStatus('Loading...');
    const path = dirId==null ? '/api/browse' : '/api/browse?'+qs({dir_id:dirId});
    const r = await api(path);
    // Restricted?
    if (r.json && r.json.authorized===false) {
      pendingDir = dirId;
      openPIN();
      setStatus('PIN required');
      return;
    }
    if (!r.ok) { setStatus('Server error'); return; }
    const data = normalizeBrowse(r.json);
    if (!data) { setStatus('Invalid JSON'); return; }

    // maintain stack (server is source of truth)
    if (!stack.length || stack[stack.length-1].id !== data.dirId) {
      stack.push({id:data.dirId, name:data.dirName});
    }
    renderPath();
    els.dirLabel.textContent = data.dirName || '/';
    renderFolders(data.folders || []);
    renderFiles(data.videos || []);
    setStatus('');
  }

  function goUp() {
    if (stack.length > 1) {
      stack.pop();                         // remove current
      const parent = stack.pop();          // reveal parent to re-push canonical from server
      authToken = "";                      // reset token when leaving a restricted area
      browse(parent.id);
    }
  }

  function browseInto(id, name) {
    stack.push({id, name});
    renderPath();
    // pop so server can canonize the name
    stack.pop();
    browse(id);
  }

  // --- Player ---
  function play(mediaId, title) {
    // Token must be in query param for video <source> (no custom headers)
    const src = SERVER + '/api/stream?' + qs({media_id: mediaId, token: authToken||''});
    els.video.src = src;
    els.player.style.display = 'flex';
    els.video.play().catch(()=>{ /* user gesture may be required */ });
  }
  function closePlayer() {
    els.video.pause();
    els.video.removeAttribute('src');
    els.player.style.display = 'none';
  }

  // --- PIN modal ---
  function openPIN() {
    els.pinError.textContent = '';
    els.pinInput.value = '';
    els.pinModal.style.display = 'flex';
    els.pinInput.focus();
  }
  function closePIN() { els.pinModal.style.display = 'none'; }

  async function submitPIN() {
    const pin = (els.pinInput.value || '').trim();
    if (!pin) { els.pinError.textContent = 'PIN required'; return; }
    const body = JSON.stringify({ dir_id: pendingDir, pin });
    const r = await api('/api/auth/folder', { method:'POST', headers:{'Content-Type':'application/json'}, body });
    if (r.ok && r.json && r.json.token) {
      authToken = r.json.token;
      closePIN();
      browse(pendingDir);
    } else {
      els.pinError.textContent = 'Invalid PIN';
    }
  }

  // --- Settings modal ---
  function openSettings(auto=false) {
    els.serverInput.value = SERVER;
    els.settingsModal.style.display = 'flex';
    els.serverInput.focus();
  }
  function closeSettings() { els.settingsModal.style.display = 'none'; }
  function saveSettings() {
    let v = (els.serverInput.value||'').trim();
    if (!v) return;
    // add scheme if missing
    if (!/^https?:\/\//i.test(v)) v = 'http://' + v;
    // strip trailing slash
    if (v.endsWith('/')) v = v.slice(0,-1);
    SERVER = v;
    storage.setItem('serverBase', SERVER);
    closeSettings();
    // reset and re-browse from root with fresh token
    stack.length = 0;
    authToken = "";
    browse(null);
  }

  // --- Events ---
  els.btnRoot.onclick = () => { stack.length = 0; authToken = ""; browse(null); };
  els.btnSettings.onclick = () => openSettings();
  els.playerClose.onclick = closePlayer;

  els.pinCancel.onclick = () => { closePIN(); setStatus(''); };
  els.pinOk.onclick = submitPIN;
  els.pinInput.addEventListener('keydown', (e)=>{ if (e.key==='Enter') submitPIN(); });

  els.settingsCancel.onclick = closeSettings;
  els.settingsOk.onclick = saveSettings;
  els.serverInput.addEventListener('keydown', (e)=>{ if (e.key==='Enter') saveSettings(); });

  // --- Boot ---
  // If first load can’t reach server, auto-open settings
  (async () => {
    try {
      await browse(null);
    } catch (e) {
      setStatus('Cannot reach server'); openSettings(true);
    }
  })();
})();
</script>
</body>
</html>
